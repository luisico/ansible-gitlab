---
- name: Ensure volume directories are present
  file: path={{item}} state=directory owner=root group=root mode=0755
  with_items:
    - '{{gitlab_config_dir}}'
    - '{{gitlab_data_dir}}'
    - '{{gitlab_logs_dir}}'

- name: Configure GitLab
  template: dest=/etc/gitlab/gitlab.rb src=gitlab.rb.j2 owner=root group=root mode=0600
  notify: Restart gitlab container

- name: Run container
  docker_container: name=gitlab image='gitlab/gitlab-ce:{{gitlab_version}}-ce.0' ports='{{gitlab_interface_address}}:443:443,{{gitlab_interface_address}}:80:80,{{gitlab_interface_address}}:22:22,{{gitlab_interface_address}}:5005:5005' hostname={{ansible_hostname}} restart_policy=always state=started log_options='max-size=100m'
  args:
    volumes:
      - '{{gitlab_config_dir}}:/etc/gitlab'
      - '{{gitlab_data_dir}}:/var/opt/gitlab'
      - '{{gitlab_logs_dir}}:/var/log/gitlab'
